<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åèŠå¤©å®¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* ... ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ï¼Œæ·»åŠ ä¸€äº›æ–°æ ·å¼ ... */
        
        .server-selector {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .server-option {
            padding: 10px 15px;
            margin: 8px 0;
            border: 2px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .server-option:hover {
            border-color: var(--primary-color);
            background-color: #f0f8ff;
        }
        
        .server-option.selected {
            border-color: var(--primary-color);
            background-color: #e8f4fc;
        }
        
        .server-option h4 {
            margin: 0 0 5px 0;
            color: var(--dark-color);
        }
        
        .server-option p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        
        .retry-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .retry-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            border: none;
        }
        
        .retry-buttons .primary-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .retry-buttons .secondary-btn {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ä¾§è¾¹æ  -->
        <!-- ... ä¿æŒåŸæœ‰ä¾§è¾¹æ ç»“æ„ä¸å˜ ... -->
    </div>

    <script>
        // é…ç½® - ä¿æŒåŸæœ‰çš„å›½é™…ç‰ˆé…ç½®
        const CONFIG = {
            // å›½é™…ç‰ˆé…ç½®ï¼ˆéœ€è¦ä»£ç†ï¼‰
            appId: 'x1C7t7inH9TDv1Ku9msDyOWi-MdYXbMMI',
            appKey: 'KLfByl3kEn1BSfhqgu3WWjDk'
        };
        
        // å›½å†…ç‰ˆæœåŠ¡å™¨é…ç½®
        const CN_SERVERS = {
            // ååŒ—èŠ‚ç‚¹ï¼ˆæ¨èï¼‰
            'ååŒ—': {
                serverURLs: 'https://x1c7t7in.lc-cn-n1-shared.com',
                description: 'ååŒ—èŠ‚ç‚¹ï¼Œä¸­å›½å¤§é™†è®¿é—®é€Ÿåº¦æœ€å¿«'
            },
            // åä¸œèŠ‚ç‚¹
            'åä¸œ': {
                serverURLs: 'https://x1c7t7in.lc-cn-e1-shared.com',
                description: 'åä¸œèŠ‚ç‚¹ï¼Œé€‚åˆåä¸œåœ°åŒºç”¨æˆ·'
            }
        };
        
        // å½“å‰é…ç½®
        let CURRENT_CONFIG = {
            ...CONFIG,
            serverURLs: '', // é»˜è®¤ä¸ºç©ºï¼ˆä½¿ç”¨å›½é™…ç‰ˆï¼‰
            useCN: false // æ˜¯å¦ä½¿ç”¨å›½å†…ç‰ˆ
        };
        
        // å½“å‰ç”¨æˆ·
        let currentUser = {
            id: '',
            name: '',
            avatar: ''
        };
        
        // æœ€åæ¶ˆæ¯æ—¶é—´
        let lastMessageTime = null;
        let pollingInterval = null;
        let retryCount = 0;
        const MAX_RETRY_COUNT = 3;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('mobileToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // åŠ è½½ç”¨æˆ·åå¥½è®¾ç½®
            loadUserPreferences();
            
            // å¯åŠ¨åº”ç”¨
            initApp();
        });
        
        // åŠ è½½ç”¨æˆ·åå¥½è®¾ç½®
        function loadUserPreferences() {
            try {
                const preferences = localStorage.getItem('chatPreferences');
                if (preferences) {
                    const pref = JSON.parse(preferences);
                    if (pref.useCN && pref.serverRegion) {
                        CURRENT_CONFIG.useCN = true;
                        CURRENT_CONFIG.serverURLs = CN_SERVERS[pref.serverRegion].serverURLs;
                        console.log('åŠ è½½ç”¨æˆ·åå¥½ï¼šä½¿ç”¨å›½å†…ç‰ˆ', pref.serverRegion);
                    }
                }
            } catch (e) {
                console.log('æ— ç”¨æˆ·åå¥½è®¾ç½®æˆ–è®¾ç½®æ— æ•ˆ');
            }
        }
        
        // ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®
        function saveUserPreferences(useCN, serverRegion) {
            const preferences = {
                useCN: useCN,
                serverRegion: serverRegion
            };
            localStorage.setItem('chatPreferences', JSON.stringify(preferences));
        }
        
        // æ˜¾ç¤ºæœåŠ¡å™¨é€‰æ‹©ç•Œé¢
        function showServerSelector() {
            const messagesContainer = document.getElementById('messages');
            
            messagesContainer.innerHTML = `
                <div class="server-selector-screen">
                    <div class="config-help" style="margin-top: 40px;">
                        <h3>ğŸŒ é€‰æ‹©æœåŠ¡å™¨èŠ‚ç‚¹</h3>
                        <p>è¯·æ ¹æ®æ‚¨çš„ç½‘ç»œç¯å¢ƒé€‰æ‹©æœåŠ¡å™¨èŠ‚ç‚¹ï¼š</p>
                        
                        <div class="server-selector" id="serverOptions">
                            <div class="server-option" data-server="international" onclick="selectServer('international')">
                                <h4>ğŸŒ å›½é™…ç‰ˆæœåŠ¡å™¨</h4>
                                <p>å…¨çƒé€šç”¨ï¼Œä½†ä¸­å›½å¤§é™†ç”¨æˆ·å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘</p>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--primary-color);">
                                    <i class="fas fa-globe"></i> æ¨èæµ·å¤–ç”¨æˆ·ä½¿ç”¨
                                </div>
                            </div>
                            
                            <div class="server-option" data-server="ååŒ—" onclick="selectServer('ååŒ—')">
                                <h4>ğŸ‡¨ğŸ‡³ å›½å†…ç‰ˆ - ååŒ—èŠ‚ç‚¹</h4>
                                <p>ä¸­å›½å¤§é™†è®¿é—®ï¼Œæ— éœ€ä»£ç†ï¼Œé€Ÿåº¦å¿«</p>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--secondary-color);">
                                    <i class="fas fa-bolt"></i> æ¨èä¸­å›½å¤§é™†ç”¨æˆ·ä½¿ç”¨
                                </div>
                            </div>
                            
                            <div class="server-option" data-server="åä¸œ" onclick="selectServer('åä¸œ')">
                                <h4>ğŸ‡¨ğŸ‡³ å›½å†…ç‰ˆ - åä¸œèŠ‚ç‚¹</h4>
                                <p>ä¸­å›½å¤§é™†è®¿é—®ï¼Œé€‚åˆåä¸œåœ°åŒºç”¨æˆ·</p>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--secondary-color);">
                                    <i class="fas fa-map-marker-alt"></i> æ¨èåä¸œåœ°åŒºç”¨æˆ·
                                </div>
                            </div>
                        </div>
                        
                        <div class="config-steps" style="margin-top: 25px;">
                            <h4>âš ï¸ é‡è¦æç¤ºï¼š</h4>
                            <ul style="text-align: left; margin: 15px auto; max-width: 600px;">
                                <li><strong>ä¸­å›½å¤§é™†ç”¨æˆ·</strong>ï¼šè¯·é€‰æ‹©ã€Œå›½å†…ç‰ˆã€èŠ‚ç‚¹ï¼Œæ— éœ€ä»£ç†å³å¯è®¿é—®</li>
                                <li><strong>æµ·å¤–ç”¨æˆ·</strong>ï¼šè¯·é€‰æ‹©ã€Œå›½é™…ç‰ˆã€æœåŠ¡å™¨</li>
                                <li>å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·å°è¯•åˆ‡æ¢å…¶ä»–èŠ‚ç‚¹</li>
                                <li>å›½å†…ç‰ˆéœ€è¦æ­£ç¡®é…ç½®å®‰å…¨åŸŸåï¼Œè¯·ç¡®ä¿å·²åœ¨ LeanCloud æ§åˆ¶å°é…ç½®</li>
                            </ul>
                            
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                <h5><i class="fas fa-exclamation-circle"></i> å®‰å…¨åŸŸåé…ç½®ï¼š</h5>
                                <p>æ— è®ºé€‰æ‹©å“ªä¸ªèŠ‚ç‚¹ï¼Œéƒ½éœ€è¦åœ¨ LeanCloud æ§åˆ¶å°é…ç½®å®‰å…¨åŸŸåï¼š</p>
                                <div style="font-family: monospace; background: white; padding: 10px; margin: 10px 0; border-radius: 5px;">
                                    1. localhost<br>
                                    2. 127.0.0.1<br>
                                    3. ${window.location.hostname || 'æ‚¨çš„åŸŸå/IP'}<br>
                                    4. * (å…è®¸æ‰€æœ‰åŸŸåï¼Œä»…æµ‹è¯•ç”¨)
                                </div>
                                <p style="font-size: 13px; color: #666;">è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œå®‰å…¨ä¸­å¿ƒã€â†’ã€ŒWeb å®‰å…¨åŸŸåã€æ·»åŠ ä»¥ä¸ŠåŸŸå</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="connectWithSelectedServer()" id="connectBtn"
                                    style="padding: 12px 30px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                å¼€å§‹è¿æ¥
                            </button>
                            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                                è¿æ¥å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // é»˜è®¤é€‰æ‹©å›½é™…ç‰ˆ
            selectServer('international');
        }
        
        // é€‰æ‹©æœåŠ¡å™¨
        function selectServer(serverType) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.server-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            const selectedOption = document.querySelector(`[data-server="${serverType}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // æ›´æ–°å½“å‰é…ç½®
            if (serverType === 'international') {
                CURRENT_CONFIG.useCN = false;
                CURRENT_CONFIG.serverURLs = '';
            } else {
                CURRENT_CONFIG.useCN = true;
                CURRENT_CONFIG.serverURLs = CN_SERVERS[serverType].serverURLs;
                CURRENT_CONFIG.serverRegion = serverType;
            }
            
            console.log('é€‰æ‹©æœåŠ¡å™¨:', serverType, CURRENT_CONFIG);
        }
        
        // ä½¿ç”¨é€‰æ‹©çš„æœåŠ¡å™¨è¿æ¥
        function connectWithSelectedServer() {
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¿æ¥ä¸­...';
            connectBtn.disabled = true;
            
            // ä¿å­˜ç”¨æˆ·åå¥½
            if (CURRENT_CONFIG.useCN && CURRENT_CONFIG.serverRegion) {
                saveUserPreferences(true, CURRENT_CONFIG.serverRegion);
            } else {
                saveUserPreferences(false, null);
            }
            
            // é‡æ–°åˆå§‹åŒ–åº”ç”¨
            setTimeout(() => {
                document.getElementById('messages').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨è¿æ¥${CURRENT_CONFIG.useCN ? 'å›½å†…ç‰ˆ' : 'å›½é™…ç‰ˆ'}æœåŠ¡å™¨...</div>
                    </div>
                `;
                initApp();
            }, 500);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                updateStatus('æ­£åœ¨åˆå§‹åŒ–...');
                updateLoadingText('æ­£åœ¨åˆå§‹åŒ–èŠå¤©å®¤...');
                
                // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
                const serverType = CURRENT_CONFIG.useCN ? 
                    `å›½å†…ç‰ˆï¼ˆ${CURRENT_CONFIG.serverRegion}ï¼‰` : 'å›½é™…ç‰ˆ';
                console.log(`ä½¿ç”¨${serverType}æœåŠ¡å™¨è¿æ¥`);
                
                // åˆå§‹åŒ–LeanCloud
                const initOptions = {
                    appId: CURRENT_CONFIG.appId,
                    appKey: CURRENT_CONFIG.appKey
                };
                
                // å¦‚æœä½¿ç”¨å›½å†…ç‰ˆï¼Œæ·»åŠ æœåŠ¡å™¨åœ°å€
                if (CURRENT_CONFIG.useCN && CURRENT_CONFIG.serverURLs) {
                    initOptions.serverURLs = CURRENT_CONFIG.serverURLs;
                    console.log('ä½¿ç”¨å›½å†…ç‰ˆæœåŠ¡å™¨:', CURRENT_CONFIG.serverURLs);
                }
                
                AV.init(initOptions);
                
                console.log('LeanCloud SDKåˆå§‹åŒ–æˆåŠŸ');
                
                // åˆå§‹åŒ–ç”¨æˆ·
                await initUser();
                
                // æµ‹è¯•è¿æ¥
                updateStatus('æ­£åœ¨è¿æ¥...');
                updateLoadingText(`æ­£åœ¨è¿æ¥åˆ°${serverType}æœåŠ¡å™¨...`);
                const connected = await testConnection();
                
                if (connected) {
                    updateStatus('å·²è¿æ¥');
                    updateLoadingText('è¿æ¥æˆåŠŸï¼ŒåŠ è½½æ¶ˆæ¯ä¸­...');
                    
                    // å¯ç”¨è¾“å…¥æ¡†
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    document.getElementById('messageInput').placeholder = "è¾“å…¥æ¶ˆæ¯...";
                    
                    // ç”µè„‘ç«¯è‡ªåŠ¨èšç„¦
                    if (window.innerWidth > 768) {
                        setTimeout(() => {
                            document.getElementById('messageInput').focus();
                        }, 500);
                    }
                    
                    // åŠ è½½æ•°æ®
                    await loadData();
                    
                    // å¼€å§‹è½®è¯¢
                    startPolling();
                    
                    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                    
                    // é‡ç½®é‡è¯•è®¡æ•°
                    retryCount = 0;
                } else {
                    throw new Error(`æ— æ³•è¿æ¥åˆ°${serverType}æœåŠ¡å™¨`);
                }
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('è¿æ¥å¤±è´¥');
                handleInitError(error);
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                console.log('æµ‹è¯•LeanCloudè¿æ¥...');
                
                // å°è¯•æŸ¥è¯¢ChatMessageè¡¨
                const ChatMessage = AV.Object.extend('ChatMessage');
                const query = new AV.Query('ChatMessage');
                query.limit(1);
                
                try {
                    const results = await query.find();
                    console.log('è¿æ¥æµ‹è¯•æˆåŠŸï¼ŒæŸ¥è¯¢åˆ°æ•°æ®:', results.length);
                    return true;
                } catch (queryError) {
                    console.log('æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•åˆ›å»ºæµ‹è¯•æ•°æ®...', queryError.message);
                    
                    // æ£€æŸ¥é”™è¯¯ç±»å‹
                    if (queryError.message.includes('401') || queryError.message.includes('Unauthorized')) {
                        console.log('è®¤è¯å¤±è´¥ï¼Œå¯èƒ½æ˜¯å®‰å…¨åŸŸåé—®é¢˜');
                        // ä»ç„¶å°è¯•åˆ›å»ºè¡¨
                    }
                    
                    // å°è¯•åˆ›å»ºä¸€æ¡æ¶ˆæ¯
                    const message = new ChatMessage();
                    message.set('content', 'ç³»ç»Ÿï¼šèŠå¤©å®¤è¿æ¥æµ‹è¯•');
                    message.set('userId', 'system_' + Date.now());
                    message.set('username', 'ç³»ç»Ÿ');
                    
                    const saved = await message.save();
                    console.log('æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ:', saved.id);
                    
                    return true;
                }
                
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé—®é¢˜
                if (error.message.includes('Network') || error.message.includes('timeout')) {
                    console.log('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨åœ°å€é”™è¯¯æˆ–éœ€è¦ä»£ç†');
                }
                
                return false;
            }
        }
        
        // å¤„ç†åˆå§‹åŒ–é”™è¯¯
        function handleInitError(error) {
            const messagesContainer = document.getElementById('messages');
            const serverType = CURRENT_CONFIG.useCN ? 'å›½å†…ç‰ˆ' : 'å›½é™…ç‰ˆ';
            
            // å¢åŠ é‡è¯•è®¡æ•°
            retryCount++;
            
            if (retryCount < MAX_RETRY_COUNT) {
                // æ˜¾ç¤ºé‡è¯•ç•Œé¢
                messagesContainer.innerHTML = `
                    <div class="error">
                        <h3>è¿æ¥å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°${serverType}æœåŠ¡å™¨ (å°è¯• ${retryCount}/${MAX_RETRY_COUNT})</p>
                        
                        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>å¯èƒ½çš„åŸå› ï¼š</h4>
                            <ul style="text-align: left; margin: 10px auto; max-width: 500px;">
                                <li>${CURRENT_CONFIG.useCN ? 'å›½å†…ç‰ˆæœåŠ¡å™¨åœ°å€é…ç½®é”™è¯¯' : 'å›½é™…ç‰ˆéœ€è¦ç§‘å­¦ä¸Šç½‘'}</li>
                                <li>LeanCloud å®‰å…¨åŸŸåæœªé…ç½®</li>
                                <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                            </ul>
                        </div>
                        
                        <div class="retry-buttons">
                            <button class="primary-btn" onclick="retryConnection()">
                                <i class="fas fa-redo"></i> é‡è¯•è¿æ¥
                            </button>
                            <button class="secondary-btn" onclick="showServerSelector()">
                                <i class="fas fa-exchange-alt"></i> åˆ‡æ¢æœåŠ¡å™¨
                            </button>
                            <button class="secondary-btn" onclick="location.reload()">
                                <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                            </button>
                        </div>
                        
                        <div style="margin-top: 25px; font-size: 14px; color: #666;">
                            <p><strong>æç¤ºï¼š</strong> ä¸­å›½å¤§é™†ç”¨æˆ·è¯·é€‰æ‹©ã€Œå›½å†…ç‰ˆã€æœåŠ¡å™¨</p>
                            <p>æµ·å¤–ç”¨æˆ·è¯·é€‰æ‹©ã€Œå›½é™…ç‰ˆã€æœåŠ¡å™¨</p>
                        </div>
                    </div>
                `;
            } else {
                // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ˜¾ç¤ºè¯¦ç»†å¸®åŠ©
                messagesContainer.innerHTML = `
                    <div class="error">
                        <h3>è¿æ¥å¤±è´¥</h3>
                        <p>å¤šæ¬¡å°è¯•è¿æ¥${serverType}æœåŠ¡å™¨å¤±è´¥</p>
                        
                        <div class="config-help">
                            <h3>ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š</h3>
                            
                            <div style="margin: 20px 0;">
                                <h4>${CURRENT_CONFIG.useCN ? 'å›½å†…ç‰ˆè¿æ¥é—®é¢˜ï¼š' : 'å›½é™…ç‰ˆè¿æ¥é—®é¢˜ï¼š'}</h4>
                                ${CURRENT_CONFIG.useCN ? `
                                    <ol>
                                        <li>æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼š
                                            <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace;">
                                                ${CURRENT_CONFIG.serverURLs || 'æœªé…ç½®æœåŠ¡å™¨åœ°å€'}
                                            </div>
                                        </li>
                                        <li>ç¡®ä¿å·²åœ¨ LeanCloud æ§åˆ¶å°é…ç½®å®‰å…¨åŸŸå</li>
                                        <li>å›½å†…ç‰ˆåº”ç”¨éœ€è¦åœ¨ã€Œè®¾ç½®ã€â†’ã€Œåº”ç”¨å‡­è¯ã€ä¸­æŸ¥çœ‹æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€</li>
                                    </ol>
                                ` : `
                                    <ol>
                                        <li>å›½é™…ç‰ˆåœ¨ä¸­å›½å¤§é™†å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘</li>
                                        <li>æˆ–è€…åˆ‡æ¢ä¸ºå›½å†…ç‰ˆæœåŠ¡å™¨</li>
                                        <li>ç¡®ä¿å·²åœ¨ LeanCloud æ§åˆ¶å°é…ç½®å®‰å…¨åŸŸå</li>
                                    </ol>
                                `}
                            </div>
                            
                            <div style="background: #e8f4fc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                <h5><i class="fas fa-cogs"></i> å®‰å…¨åŸŸåé…ç½®æ­¥éª¤ï¼š</h5>
                                <ol style="text-align: left;">
                                    <li>è®¿é—® <a href="https://console.leancloud.app/" target="_blank">LeanCloud æ§åˆ¶å°</a></li>
                                    <li>è¿›å…¥æ‚¨çš„åº”ç”¨</li>
                                    <li>ç‚¹å‡»ã€Œè®¾ç½®ã€â†’ã€Œå®‰å…¨ä¸­å¿ƒã€</li>
                                    <li>åœ¨ã€ŒWeb å®‰å…¨åŸŸåã€ä¸­æ·»åŠ ï¼š
                                        <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace;">
                                            localhost<br>
                                            127.0.0.1<br>
                                            ${window.location.hostname || 'æ‚¨çš„åŸŸå/IP'}<br>
                                            * (å…è®¸æ‰€æœ‰åŸŸåï¼Œä»…æµ‹è¯•ç”¨)
                                        </div>
                                    </li>
                                    <li>ç‚¹å‡»ã€Œä¿å­˜ã€</li>
                                </ol>
                            </div>
                            
                            <div class="retry-buttons">
                                <button class="primary-btn" onclick="showServerSelector()">
                                    <i class="fas fa-exchange-alt"></i> åˆ‡æ¢æœåŠ¡å™¨èŠ‚ç‚¹
                                </button>
                                <button class="secondary-btn" onclick="location.reload()">
                                    <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // é‡è¯•è¿æ¥
        function retryConnection() {
            console.log('é‡è¯•è¿æ¥...', retryCount);
            document.getElementById('messages').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨é‡è¯•è¿æ¥ (${retryCount + 1}/${MAX_RETRY_COUNT})...</div>
                </div>
            `;
            initApp();
        }
        
        // ... å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆinitUser, loadData, sendMessageç­‰ï¼‰...
        // æ³¨æ„ï¼šéœ€è¦ä¿æŒåŸæœ‰çš„ initUser, updateLoadingText, loadData, sendMessage ç­‰å‡½æ•°
        
        // åœ¨ initApp å¼€å§‹æ—¶æ·»åŠ æ£€æŸ¥
        // ä¿®æ”¹åŸæ¥çš„ initApp å‡½æ•°å¼€å¤´éƒ¨åˆ†ï¼š
        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨é€‰æ‹©ç•Œé¢
                const firstVisit = !localStorage.getItem('chatPreferences');
                if (firstVisit) {
                    showServerSelector();
                    updateStatus('é€‰æ‹©æœåŠ¡å™¨');
                    return;
                }
                
                updateStatus('æ­£åœ¨åˆå§‹åŒ–...');
                // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜ ...
            } catch (error) {
                // ... é”™è¯¯å¤„ç†ä¿æŒä¸å˜ ...
            }
        }
    </script>
</body>
</html>