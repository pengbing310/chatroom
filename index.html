<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>匿名聊天室 - 调试版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* 简化样式，专注于功能 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial; font-size: 18px; background: white; color: #333; }
        
        .container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #f8f9fa; border-right: 1px solid #ddd; padding: 20px; }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; font-size: 18px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>匿名聊天室</h2>
            <div class="debug-info">
                <div><strong>状态:</strong> <span id="statusText" class="status connecting">连接中...</span></div>
                <div><strong>用户:</strong> <span id="userInfo">未登录</span></div>
                <div><strong>消息数:</strong> <span id="messageCount">0</span></div>
                <button onclick="checkConnection()" style="margin-top: 10px; padding: 5px 10px; font-size: 14px;">测试连接</button>
                <button onclick="clearLocalData()" style="margin-top: 5px; padding: 5px 10px; font-size: 14px; background: #e74c3c;">清除本地数据</button>
            </div>
            <div style="margin-top: 20px;">
                <h3>配置信息</h3>
                <div style="font-size: 12px; word-break: break-all;">
                    <div>App ID 前6位: <span id="appIdPreview">未设置</span></div>
                    <div>当前域名: <span id="currentDomain"></span></div>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="messages" id="messages">
                <div id="welcomeMessage">正在连接 LeanCloud...</div>
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="输入消息..." disabled>
                <button id="sendButton" onclick="sendMessage()" disabled>发送</button>
            </div>
        </div>
    </div>

    <script>
        // ===================== 配置区域 =====================
        // 请替换为您的 LeanCloud 配置
        const LEANCLOUD_CONFIG = {
            appId: 'x1C7t7inH9TDv1Ku9msDyOWi-MdYXbMMI',      // 替换为您的 App ID
            appKey: 'KLfByl3kEn1BSfhqgu3WWjDk',   // 替换为您的 App Key
            serverURL: ''  // 通常留空，除非使用自定义域名
        };
        
        // 显示配置预览
        document.getElementById('appIdPreview').textContent = LEANCLOUD_CONFIG.appId ? 
            LEANCLOUD_CONFIG.appId.substring(0, 6) + '...' : '未设置';
        document.getElementById('currentDomain').textContent = window.location.hostname;
        
        // ===================== 全局变量 =====================
        let currentUser = {
            id: null,
            name: null
        };
        
        // ===================== 初始化 =====================
        document.addEventListener('DOMContentLoaded', async function() {
            updateStatus('正在初始化...', 'connecting');
            
            // 1. 检查配置
            if (!LEANCLOUD_CONFIG.appId || LEANCLOUD_CONFIG.appId.includes('YOUR_') || 
                !LEANCLOUD_CONFIG.appKey || LEANCLOUD_CONFIG.appKey.includes('YOUR_')) {
                showError('请先配置 LeanCloud App ID 和 App Key');
                return;
            }
            
            // 2. 初始化 LeanCloud
            try {
                AV.init({
                    appId: LEANCLOUD_CONFIG.appId,
                    appKey: LEANCLOUD_CONFIG.appKey,
                    serverURL: LEANCLOUD_CONFIG.serverURL || undefined
                });
                
                updateStatus('LeanCloud 初始化成功', 'connected');
                
                // 3. 初始化用户
                await initUser();
                
                // 4. 测试连接
                await testConnection();
                
                // 5. 加载历史消息
                await loadMessages();
                
                // 6. 启用输入框
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('messageInput').focus();
                
            } catch (error) {
                console.error('初始化失败:', error);
                showError('初始化失败: ' + error.message);
            }
        });
        
        // ===================== 核心函数 =====================
        
        // 初始化用户
        async function initUser() {
            // 生成用户ID
            let userId = localStorage.getItem('chatUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('chatUserId', userId);
            }
            
            // 分配用户名
            const usernames = ['甲', '乙', '丙', '丁', '孙悟空', '哪吒', '敖丙', 'susu', 'haha'];
            let username = localStorage.getItem('chatUsername');
            if (!username) {
                username = usernames[Math.floor(Math.random() * usernames.length)];
                localStorage.setItem('chatUsername', username);
            }
            
            currentUser = { id: userId, name: username };
            document.getElementById('userInfo').textContent = username + ' (' + userId.substring(0, 8) + '...)';
        }
        
        // 测试连接
        async function testConnection() {
            try {
                updateStatus('测试连接中...', 'connecting');
                
                // 尝试创建一个测试对象
                const TestObject = AV.Object.extend('TestConnection');
                const testObj = new TestObject();
                testObj.set('testField', 'testValue_' + Date.now());
                testObj.set('userId', currentUser.id);
                
                const savedObj = await testObj.save();
                updateStatus('连接测试成功 - 对象ID: ' + savedObj.id, 'connected');
                
                // 清理测试对象
                await savedObj.destroy();
                
                return true;
            } catch (error) {
                console.error('连接测试失败:', error);
                showError('连接测试失败: ' + error.message);
                return false;
            }
        }
        
        // 加载消息
        async function loadMessages() {
            try {
                const query = new AV.Query('ChatMessage');
                query.descending('createdAt');
                query.limit(20);
                
                const messages = await query.find();
                document.getElementById('messageCount').textContent = messages.length;
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">还没有消息，发送第一条吧！</div>';
                    return;
                }
                
                // 按时间正序显示
                messages.reverse().forEach(msg => {
                    addMessageToUI({
                        id: msg.id,
                        sender: msg.get('username'),
                        content: msg.get('content'),
                        time: msg.createdAt.toLocaleTimeString()
                    });
                });
                
            } catch (error) {
                console.error('加载消息失败:', error);
                showError('加载消息失败: ' + error.message);
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            try {
                // 1. 创建消息对象
                const ChatMessage = AV.Object.extend('ChatMessage');
                const message = new ChatMessage();
                
                message.set('userId', currentUser.id);
                message.set('username', currentUser.name);
                message.set('content', messageText);
                
                // 2. 保存到 LeanCloud
                const savedMessage = await message.save();
                
                // 3. 显示消息
                addMessageToUI({
                    id: savedMessage.id,
                    sender: currentUser.name,
                    content: messageText,
                    time: new Date().toLocaleTimeString(),
                    isSelf: true
                });
                
                // 4. 更新消息计数
                const count = parseInt(document.getElementById('messageCount').textContent);
                document.getElementById('messageCount').textContent = count + 1;
                
                // 5. 清空输入框
                input.value = '';
                input.focus();
                
                updateStatus('消息发送成功: ' + savedMessage.id, 'connected');
                
            } catch (error) {
                console.error('发送消息失败:', error);
                showError('发送失败: ' + error.message);
            }
        }
        
        // ===================== 辅助函数 =====================
        
        function addMessageToUI(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            
            msgDiv.style.cssText = `
                margin: 10px 0;
                padding: 10px 15px;
                background: ${msg.isSelf ? '#3498db' : 'white'};
                color: ${msg.isSelf ? 'white' : '#333'};
                border-radius: 10px;
                max-width: 80%;
                ${msg.isSelf ? 'margin-left: auto; border-bottom-right-radius: 3px;' : 'border-bottom-left-radius: 3px;'}
                border: ${msg.isSelf ? 'none' : '1px solid #ddd'};
            `;
            
            msgDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">
                    ${msg.sender}${msg.isSelf ? ' (我)' : ''}
                </div>
                <div>${escapeHtml(msg.content)}</div>
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                    ${msg.time}
                </div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(text, type) {
            const statusEl = document.getElementById('statusText');
            statusEl.textContent = text;
            statusEl.className = 'status ' + type;
            console.log('状态:', text);
        }
        
        function showError(text) {
            updateStatus(text, 'error');
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div style="color: #721c24; background: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px;">
                    <h3>错误</h3>
                    <p>${escapeHtml(text)}</p>
                    <p>请检查：</p>
                    <ol>
                        <li>LeanCloud App ID 和 App Key 是否正确</li>
                        <li>是否在 LeanCloud 控制台设置了 Web 安全域名</li>
                        <li>网络连接是否正常</li>
                    </ol>
                    <button onclick="location.reload()" style="padding: 8px 15px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        重新加载
                    </button>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===================== 调试函数 =====================
        
        window.checkConnection = async function() {
            const connected = await testConnection();
            if (connected) {
                await loadMessages();
            }
        };
        
        window.clearLocalData = function() {
            localStorage.removeItem('chatUserId');
            localStorage.removeItem('chatUsername');
            location.reload();
        };
        
        // 添加键盘支持
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>